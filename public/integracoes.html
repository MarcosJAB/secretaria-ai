<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integrações - Secretária AI</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .integrations-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .page-title {
      text-align: center;
      margin-bottom: 3rem;
      color: #333;
    }
    
    .integration-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 2rem;
    }
    
    .integration-card {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .integration-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .integration-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .integration-icon {
      width: 50px;
      height: 50px;
      margin-right: 1rem;
    }
    
    .integration-title {
      font-size: 1.5rem;
      margin: 0;
      color: #333;
    }
    
    .integration-description {
      color: #666;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .integration-status {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-connected {
      background-color: #4CAF50;
    }
    
    .status-disconnected {
      background-color: #F44336;
    }
    
    .integration-actions {
      display: flex;
      justify-content: space-between;
    }
    
    .action-button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .connect-button {
      background-color: #4285F4;
      color: white;
    }
    
    .connect-button:hover {
      background-color: #3367D6;
    }
    
    .disconnect-button {
      background-color: #F44336;
      color: white;
    }
    
    .disconnect-button:hover {
      background-color: #D32F2F;
    }
    
    .qr-code-container {
      margin-top: 1.5rem;
      text-align: center;
      display: none;
    }
    
    .qr-code-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 1rem;
    }
    
    .qr-code-instructions {
      font-size: 0.9rem;
      color: #666;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="integrations-container">
    <h1 class="page-title">Integrações</h1>
    
    <div class="integration-cards">
      <!-- WhatsApp Integration Card -->
      <div class="integration-card" id="whatsapp-card">
        <div class="integration-header">
          <img src="/img/whatsapp-icon.svg" alt="WhatsApp" class="integration-icon">
          <h2 class="integration-title">WhatsApp</h2>
        </div>
        
        <p class="integration-description">
          Conecte sua conta do WhatsApp para enviar e receber mensagens automaticamente através da Secretária AI.
        </p>
        
        <div class="integration-status">
          <span class="status-indicator status-disconnected" id="whatsapp-status-indicator"></span>
          <span id="whatsapp-status-text">Desconectado</span>
        </div>
        
        <div class="integration-actions">
          <button class="action-button connect-button" id="whatsapp-connect-btn">Conectar</button>
          <button class="action-button disconnect-button" id="whatsapp-disconnect-btn" style="display: none;">Desconectar</button>
        </div>
        
        <div class="qr-code-container" id="whatsapp-qr-container">
          <img src="" alt="QR Code" class="qr-code-image" id="whatsapp-qr-image">
          <p class="qr-code-instructions">Escaneie este QR Code com seu WhatsApp para conectar sua conta.</p>
        </div>
      </div>
      
      <!-- Google Calendar Integration Card -->
      <div class="integration-card" id="google-calendar-card">
        <div class="integration-header">
          <img src="/img/google-calendar-icon.svg" alt="Google Calendar" class="integration-icon">
          <h2 class="integration-title">Google Calendar</h2>
        </div>
        
        <p class="integration-description">
          Conecte sua conta do Google Calendar para gerenciar seus eventos e compromissos através da Secretária AI.
        </p>
        
        <div class="integration-status">
          <span class="status-indicator status-disconnected" id="google-calendar-status-indicator"></span>
          <span id="google-calendar-status-text">Desconectado</span>
        </div>
        
        <div class="integration-actions">
          <button class="action-button connect-button" id="google-calendar-connect-btn">Conectar</button>
          <button class="action-button disconnect-button" id="google-calendar-disconnect-btn" style="display: none;">Desconectar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar status das integrações ao carregar a página
      checkWhatsAppStatus();
      checkGoogleCalendarStatus();
      
      // Event listeners para botões
      document.getElementById('whatsapp-connect-btn').addEventListener('click', connectWhatsApp);
      document.getElementById('whatsapp-disconnect-btn').addEventListener('click', disconnectWhatsApp);
      document.getElementById('google-calendar-connect-btn').addEventListener('click', connectGoogleCalendar);
      document.getElementById('google-calendar-disconnect-btn').addEventListener('click', disconnectGoogleCalendar);
      
      // Função para obter token de autenticação do localStorage
      function getAuthToken() {
        return localStorage.getItem('authToken');
      }
      
      // Verificar status da integração com WhatsApp
      function checkWhatsAppStatus() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        fetch('/api/whatsapp/status', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          updateWhatsAppStatus(data.success && data.status.connected);
        })
        .catch(error => {
          console.error('Erro ao verificar status do WhatsApp:', error);
          updateWhatsAppStatus(false);
        });
      }
      
      // Atualizar interface com status do WhatsApp
      function updateWhatsAppStatus(isConnected) {
        const statusIndicator = document.getElementById('whatsapp-status-indicator');
        const statusText = document.getElementById('whatsapp-status-text');
        const connectBtn = document.getElementById('whatsapp-connect-btn');
        const disconnectBtn = document.getElementById('whatsapp-disconnect-btn');
        
        if (isConnected) {
          statusIndicator.className = 'status-indicator status-connected';
          statusText.textContent = 'Conectado';
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'block';
        } else {
          statusIndicator.className = 'status-indicator status-disconnected';
          statusText.textContent = 'Desconectado';
          connectBtn.style.display = 'block';
          disconnectBtn.style.display = 'none';
        }
      }
      
      // Conectar WhatsApp
      function connectWhatsApp() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        // Mostrar estado de carregamento no botão
        const connectBtn = document.getElementById('whatsapp-connect-btn');
        const originalText = connectBtn.textContent;
        connectBtn.innerHTML = '<span class="loading-spinner"></span>Conectando...';
        connectBtn.disabled = true;
        
        fetch('/api/whatsapp/connect', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Iniciar polling para obter QR Code
            getWhatsAppQRCode();
          } else {
            alert('Erro ao iniciar conexão: ' + data.message);
            connectBtn.innerHTML = originalText;
            connectBtn.disabled = false;
          }
        })
        .catch(error => {
          console.error('Erro ao conectar WhatsApp:', error);
          alert('Erro ao conectar WhatsApp. Tente novamente.');
          connectBtn.innerHTML = originalText;
          connectBtn.disabled = false;
        });
      }
      
      // Obter QR Code do WhatsApp
      function getWhatsAppQRCode() {
        const token = getAuthToken();
        if (!token) return;
        
        const qrContainer = document.getElementById('whatsapp-qr-container');
        const qrImage = document.getElementById('whatsapp-qr-image');
        
        // Função para verificar QR Code periodicamente
        function checkQRCode() {
          fetch('/api/whatsapp/qrcode', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.qrCode) {
              // Exibir QR Code
              qrImage.src = data.qrCode;
              qrContainer.style.display = 'block';
              
              // Continuar verificando status
              setTimeout(checkStatus, 5000);
            } else {
              // Tentar novamente em 2 segundos
              setTimeout(checkQRCode, 2000);
            }
          })
          .catch(error => {
            console.error('Erro ao obter QR Code:', error);
            setTimeout(checkQRCode, 5000);
          });
        }
        
        // Função para verificar status da conexão
        function checkStatus() {
          fetch('/api/whatsapp/status', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              if (data.status.connected) {
                // Conexão estabelecida
                updateWhatsAppStatus(true);
                qrContainer.style.display = 'none';
                document.getElementById('whatsapp-connect-btn').innerHTML = 'Conectar';
                document.getElementById('whatsapp-connect-btn').disabled = false;
              } else if (data.status.status === 'connecting') {
                // Ainda conectando, continuar verificando
                setTimeout(checkStatus, 5000);
              } else {
                // Falha na conexão
                updateWhatsAppStatus(false);
                qrContainer.style.display = 'none';
                document.getElementById('whatsapp-connect-btn').innerHTML = 'Conectar';
                document.getElementById('whatsapp-connect-btn').disabled = false;
                alert('Falha na conexão com WhatsApp. Tente novamente.');
              }
            }
          })
          .catch(error => {
            console.error('Erro ao verificar status:', error);
            setTimeout(checkStatus, 5000);
          });
        }
        
        // Iniciar verificação de QR Code
        checkQRCode();
      }
      
      // Desconectar WhatsApp
      function disconnectWhatsApp() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        // Mostrar estado de carregamento no botão
        const disconnectBtn = document.getElementById('whatsapp-disconnect-btn');
        const originalText = disconnectBtn.textContent;
        disconnectBtn.innerHTML = '<span class="loading-spinner"></span>Desconectando...';
        disconnectBtn.disabled = true;
        
        fetch('/api/whatsapp/disconnect', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateWhatsAppStatus(false);
          } else {
            alert('Erro ao desconectar: ' + data.message);
          }
          disconnectBtn.innerHTML = originalText;
          disconnectBtn.disabled = false;
        })
        .catch(error => {
          console.error('Erro ao desconectar WhatsApp:', error);
          alert('Erro ao desconectar WhatsApp. Tente novamente.');
          disconnectBtn.innerHTML = originalText;
          disconnectBtn.disabled = false;
        });
      }
      
      // Verificar status da integração com Google Calendar
      function checkGoogleCalendarStatus() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        fetch('/api/google-calendar/status', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          updateGoogleCalendarStatus(data.success && data.connected);
        })
        .catch(error => {
          console.error('Erro ao verificar status do Google Calendar:', error);
          updateGoogleCalendarStatus(false);
        });
      }
      
      // Atualizar interface com status do Google Calendar
      function updateGoogleCalendarStatus(isConnected) {
        const statusIndicator = document.getElementById('google-calendar-status-indicator');
        const statusText = document.getElementById('google-calendar-status-text');
        const connectBtn = document.getElementById('google-calendar-connect-btn');
        const disconnectBtn = document.getElementById('google-calendar-disconnect-btn');
        
        if (isConnected) {
          statusIndicator.className = 'status-indicator status-connected';
          statusText.textContent = 'Conectado';
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'block';
        } else {
          statusIndicator.className = 'status-indicator status-disconnected';
          statusText.textContent = 'Desconectado';
          connectBtn.style.display = 'block';
          disconnectBtn.style.display = 'none';
        }
      }
      
      // Conectar Google Calendar
      function connectGoogleCalendar() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        // Mostrar estado de carregamento no botão
        const connectBtn = document.getElementById('google-calendar-connect-btn');
        const originalText = connectBtn.textContent;
        connectBtn.innerHTML = '<span class="loading-spinner"></span>Conectando...';
        connectBtn.disabled = true;
        
        fetch('/api/google-calendar/auth-url', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.authUrl) {
            // Redirecionar para URL de autorização do Google
            window.location.href = data.authUrl;
          } else {
            alert('Erro ao obter URL de autorização: ' + data.message);
            connectBtn.innerHTML = originalText;
            connectBtn.disabled = false;
          }
        })
        .catch(error => {
          console.error('Erro ao conectar Google Calendar:', error);
          alert('Erro ao conectar Google Calendar. Tente novamente.');
          connectBtn.innerHTML = originalText;
          connectBtn.disabled = false;
        });
      }
      
      // Desconectar Google Calendar
      function disconnectGoogleCalendar() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = '/login.html';
          return;
        }
        
        // Mostrar estado de carregamento no botão
        const disconnectBtn = document.getElementById('google-calendar-disconnect-btn');
        const originalText = disconnectBtn.textContent;
        disconnectBtn.innerHTML = '<span class="loading-spinner"></span>Desconectando...';
        disconnectBtn.disabled = true;
        
        fetch('/api/google-calendar/disconnect', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateGoogleCalendarStatus(false);
          } else {
            alert('Erro ao desconectar: ' + data.message);
          }
          disconnectBtn.innerHTML = originalText;
          disconnectBtn.disabled = false;
        })
        .catch(error => {
          console.error('Erro ao desconectar Google Calendar:', error);
          alert('Erro ao desconectar Google Calendar. Tente novamente.');
          disconnectBtn.innerHTML = originalText;
          disconnectBtn.disabled = false;
        });
      }
    });
  </script>
</body>
</html>